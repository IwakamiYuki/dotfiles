#!/bin/bash

# tmux pane border format script
# Display current path with hash-based color blocks and git branch

original_path="$1"
current_path="$1"

# パスが空の場合はデフォルト表示
if [ -z "$current_path" ]; then
  echo "N/A"
  exit 0
fi

# パスのMD5ハッシュを計算してカラーブロックを生成
if command -v md5 &> /dev/null; then
  hash=$(echo -n "$original_path" | md5 | cut -c1-6)
else
  hash=$(echo -n "$original_path" | md5sum | cut -c1-6)
fi

# ハッシュ値を2つの16進数値に分割（各3文字）
color1=$(echo "${hash:0:3}")
color2=$(echo "${hash:3:3}")

# 明るく鮮やかな色パレット（256色の中から視認性の高い色を選択）
# 明るい色（RGB値が高い）を優先的に選択
vivid_colors=(11 12 13 14 15 46 47 48 49 50 51 82 83 84 85 86 87 118 119 120 121 122 123 154 155 156 157 158 159 190 191 192 193 194 195 226 227 228 229 230 231)

# ハッシュから色インデックスを計算
idx1=$((16#${color1} % ${#vivid_colors[@]}))
idx2=$((16#${color2} % ${#vivid_colors[@]}))

dec1=${vivid_colors[$idx1]}
dec2=${vivid_colors[$idx2]}

# ホームディレクトリを ~ に置換
current_path="${current_path/#$HOME/~}"

# パスが長すぎる場合は短縮（最大40文字）
max_length=40
if [ ${#current_path} -gt $max_length ]; then
    # 最後のディレクトリ名のみを表示
    current_path=".../${current_path##*/}"
fi

# 最初の1文字を抽出
first_char="${current_path:0:1}"
rest_path="${current_path:1}"

# パスを1色で表現（アンダーライン付き）
colored_path="#[fg=colour$dec1,underscore]$first_char$rest_path#[default]"

# ブランチアイコン（代替キー記号 U+2387）
branch_icon="⎇"

# Git ブランチ名を取得
if [ -d "$1/.git" ] || git -C "$1" rev-parse --git-dir > /dev/null 2>&1; then
    branch=$(git -C "$1" symbolic-ref --short HEAD 2>/dev/null || git -C "$1" describe --tags --exact-match 2>/dev/null || git -C "$1" rev-parse --short HEAD 2>/dev/null)
    if [ -n "$branch" ]; then
        # Git の dirty 状態をチェック
        if ! git -C "$1" diff --quiet 2>/dev/null || ! git -C "$1" diff --cached --quiet 2>/dev/null; then
            dirty="*"
        else
            dirty=""
        fi
        # ブランチ名と記号を2色目で表示
        echo "$colored_path │ #[fg=colour$dec2]$branch_icon $branch$dirty#[default]"
    else
        echo "$colored_path"
    fi
else
    echo "$colored_path"
fi
