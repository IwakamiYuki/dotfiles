#!/bin/bash

# tmux pane border format script
# Display current path with hash-based color blocks and git branch

original_path="$1"
current_path="$1"

# ãƒ‘ã‚¹ãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
if [ -z "$current_path" ]; then
  echo "N/A"
  exit 0
fi

# ãƒ‘ã‚¹ã®MD5ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—ã—ã¦ã‚«ãƒ©ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç”Ÿæˆ
if command -v md5 &> /dev/null; then
  hash=$(echo -n "$original_path" | md5 | cut -c1-6)
else
  hash=$(echo -n "$original_path" | md5sum | cut -c1-6)
fi

# ãƒãƒƒã‚·ãƒ¥å€¤ã‚’2ã¤ã®16é€²æ•°å€¤ã«åˆ†å‰²ï¼ˆå„3æ–‡å­—ï¼‰
color1=$(echo "${hash:0:3}")
color2=$(echo "${hash:3:3}")

# æ˜ã‚‹ãé®®ã‚„ã‹ãªè‰²ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆ256è‰²ã®ä¸­ã‹ã‚‰è¦–èªæ€§ã®é«˜ã„è‰²ã‚’é¸æŠï¼‰
# æ˜ã‚‹ã„è‰²ï¼ˆRGBå€¤ãŒé«˜ã„ï¼‰ã‚’å„ªå…ˆçš„ã«é¸æŠ
vivid_colors=(11 12 13 14 15 46 47 48 49 50 51 82 83 84 85 86 87 118 119 120 121 122 123 154 155 156 157 158 159 190 191 192 193 194 195 226 227 228 229 230 231)

# ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰è‰²ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
idx1=$((16#${color1} % ${#vivid_colors[@]}))
idx2=$((16#${color2} % ${#vivid_colors[@]}))

dec1=${vivid_colors[$idx1]}
dec2=${vivid_colors[$idx2]}

# çµµæ–‡å­—ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆworktreeã”ã¨ã«ç•°ãªã‚‹çµµæ–‡å­—ã‚’è¡¨ç¤ºï¼‰
# èƒŒæ™¯è‰²ã§ååˆ†è­˜åˆ¥ã§ãã‚‹ã‚ˆã†ã€ã‚ã‹ã‚Šã‚„ã™ã„çµµæ–‡å­—ã‚’å³é¸
emoji_palette=(ğŸŒ³ ğŸ¯ ğŸ“¦ ğŸš€ ğŸ”¬ âš¡ ğŸ¨ ğŸ› ï¸ ğŸ’¾ ğŸ­ ğŸ† ğŸ“š ğŸ”§ ğŸª ğŸŒ² ğŸ—ï¸ ğŸ’¡ ğŸµ ğŸ® ğŸ  ğŸ¥ ğŸ¦ ğŸª ğŸ¢ ğŸš— ğŸš• ğŸš™ ğŸšŒ ğŸš ğŸš ğŸš‘ ğŸš’ ğŸš ğŸšš ğŸš› ğŸšœ âœˆï¸ ğŸš ğŸš‚ ğŸš† ğŸš‡ ğŸšˆ ğŸšŠ ğŸš ğŸš ğŸš‹ ğŸš„ ğŸš… ğŸšˆ ğŸš ğŸš† â›µ ğŸ›¥ï¸ ğŸš¤ ğŸ›³ï¸ â›´ï¸ ğŸ›°ï¸ ğŸš€ ğŸ›¸ â° â±ï¸ â²ï¸ ğŸ•°ï¸ âŒš âŒ› â³ ğŸ“± ğŸ“² ğŸ’» âŒ¨ï¸ ğŸ–¥ï¸ ğŸ–¨ï¸ ğŸ–±ï¸ ğŸ–²ï¸ ğŸ•¹ï¸ ğŸ—œï¸ ğŸ’½ ğŸ’¾ ğŸ’¿ ğŸ“€ ğŸ“¼ ğŸ“· ğŸ“¸ ğŸ“¹ ğŸ¥ ğŸ¬ ğŸ“½ï¸ ğŸï¸ ğŸ“ â˜ï¸ ğŸ“Ÿ ğŸ“  ğŸ“º ğŸ“» ğŸ™ï¸ ğŸšï¸ ğŸ›ï¸ ğŸ§­ âš–ï¸ ğŸ§° ğŸ”§ ğŸ”¨ â›ï¸ âš’ï¸ ğŸ› ï¸ âš”ï¸ ğŸ”“ ğŸ”’ ğŸ” ğŸ” ğŸ”‘ ğŸ—ï¸ ğŸšª ğŸ›—)

# ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰çµµæ–‡å­—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
emoji_idx=$((16#${color1} % ${#emoji_palette[@]}))
emoji=${emoji_palette[$emoji_idx]}

# ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ ~ ã«ç½®æ›
current_path="${current_path/#$HOME/~}"

# ãƒ‘ã‚¹ãŒé•·ã™ãã‚‹å ´åˆã¯çŸ­ç¸®ï¼ˆæœ€å¤§40æ–‡å­—ï¼‰
max_length=40
if [ ${#current_path} -gt $max_length ]; then
    # æœ€å¾Œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã®ã¿ã‚’è¡¨ç¤º
    current_path=".../${current_path##*/}"
fi

# æœ€åˆã®1æ–‡å­—ã‚’æŠ½å‡º
first_char="${current_path:0:1}"
rest_path="${current_path:1}"

# ãƒ‘ã‚¹ã‚’1è‰²ã§è¡¨ç¾ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³ä»˜ãï¼‰ã€èƒŒæ™¯è‰²ä»˜ãçµµæ–‡å­—
colored_path="#[bg=colour$dec1,fg=colour232] $emoji #[default] #[fg=colour$dec1,underscore]$first_char$rest_path#[default]"

# ãƒ–ãƒ©ãƒ³ãƒã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä»£æ›¿ã‚­ãƒ¼è¨˜å· U+2387ï¼‰
branch_icon="â‡"

# Git ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
if [ -d "$1/.git" ] || git -C "$1" rev-parse --git-dir > /dev/null 2>&1; then
    branch=$(git -C "$1" symbolic-ref --short HEAD 2>/dev/null || git -C "$1" describe --tags --exact-match 2>/dev/null || git -C "$1" rev-parse --short HEAD 2>/dev/null)
    if [ -n "$branch" ]; then
        # Git ã® dirty çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        if ! git -C "$1" diff --quiet 2>/dev/null || ! git -C "$1" diff --cached --quiet 2>/dev/null; then
            dirty="*"
        else
            dirty=""
        fi
        # ãƒ–ãƒ©ãƒ³ãƒåã¨è¨˜å·ã‚’2è‰²ç›®ã§è¡¨ç¤º
        echo "$colored_path â”‚ #[fg=colour$dec2]$branch_icon $branch$dirty#[default]"
    else
        echo "$colored_path"
    fi
else
    echo "$colored_path"
fi
